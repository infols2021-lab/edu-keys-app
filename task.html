<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ó–∞–¥–∞–Ω–∏–µ ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .task-content { margin-bottom: 20px; }
    .question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .question:last-child { border-bottom: none; }
    .question-image-container { text-align: center; margin: 15px 0; }
    .question-image { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .options { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .option { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; transition: background-color 0.2s; cursor: pointer; }
    .option:hover { background-color: rgba(0,0,0,0.03); }
    .option input[type="radio"] { margin: 0; cursor: pointer; }
    .fill-input { padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 16px; width: 200px; }
    .fill-input:focus { border-color: var(--accent2); outline: none; }
    .attempt-warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #856404; }
    .timer { background: var(--accent2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-left: 10px; }
    .timer.warning { background: var(--accent); animation: pulse 1s infinite; }
    .timer.danger { background: #e74c3c; animation: pulse 0.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .disabled { opacity: 0.6; pointer-events: none; }
    .loading { text-align: center; padding: 40px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent2); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .completed-message { background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; }
    .time-info { background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="mark">EK</div>
        <div>
          <h3 id="pageTitle">–ó–∞–¥–∞–Ω–∏–µ</h3>
          <div class="small-muted" id="subTitle"></div>
        </div>
      </div>
      <div class="nav">
        <button class="btn" onclick="location.href='/tasks.html'">–ö –∑–∞–¥–∞–Ω–∏—è–º</button>
      </div>
    </div>

    <div class="card">
      <div id="attemptWarning" class="attempt-warning" style="display: none;"></div>
      <div id="timeInfo" class="time-info" style="display: none;"></div>
      
      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>–ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è...</p>
      </div>
      
      <div id="completedMessage" class="completed-message" style="display: none;">
        <h3>–ó–∞–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</h3>
        <p id="completedText"></p>
        <button class="btn" onclick="location.href='/tasks.html'">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–¥–∞–Ω–∏—è–º</button>
      </div>
      
      <div id="taskBody" class="task-content"></div>
      
      <div style="margin-top: 16px; display: flex; gap: 8px; align-items: center;">
        <button id="submitBtn" class="btn" style="display: none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        <div id="timer" class="timer" style="display: none;">00:00</div>
        <button class="btn secondary" onclick="location.href='/tasks.html'">–ù–∞–∑–∞–¥ –∫ –∑–∞–¥–∞–Ω–∏—è–º</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">–û–ö</button>
      </div>
    </div>
  </div>

  <script src="/config.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY)

    const params = new URLSearchParams(window.location.search)
    const taskId = params.get('id')
    let task = null
    let user = null
    let currentAttemptId = null
    let attemptStarted = false
    let startTime = null
    let timerInterval = null
    let timeLimit = 60

    const submitBtn = document.getElementById('submitBtn')
    const taskBody = document.getElementById('taskBody')
    const attemptWarning = document.getElementById('attemptWarning')
    const timeInfo = document.getElementById('timeInfo')
    const timerElement = document.getElementById('timer')
    const loadingElement = document.getElementById('loading')
    const completedMessage = document.getElementById('completedMessage')
    const completedText = document.getElementById('completedText')

    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title
      document.getElementById('modalText').textContent = text
      document.getElementById('modal').style.display = 'flex'
    }

    document.getElementById('modalOk').addEventListener('click', () => {
      document.getElementById('modal').style.display = 'none'
      if (document.getElementById('modalTitle').textContent.includes('üéâ')) {
        window.location.href = '/tasks.html'
      }
    })

    function startCountdown() {
      if (!startTime) return
      
      function updateTimer() {
        const now = new Date()
        const elapsed = Math.floor((now - startTime) / 1000)
        const remaining = timeLimit * 60 - elapsed
        
        if (remaining <= 0) {
          // –í—Ä–µ–º—è –≤—ã—à–ª–æ
          clearInterval(timerInterval)
          timerElement.textContent = "00:00"
          timerElement.className = "timer danger"
          submitBtn.disabled = true
          submitBtn.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!"
          attemptWarning.innerHTML = '<strong>‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!</strong> –ó–∞–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'
          autoSubmit()
        } else {
          const minutes = Math.floor(remaining / 60)
          const seconds = remaining % 60
          timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
          
          // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –º–∞–ª–æ–º –æ—Å—Ç–∞—Ç–∫–µ –≤—Ä–µ–º–µ–Ω–∏
          if (remaining < 300) { // 5 –º–∏–Ω—É—Ç
            timerElement.className = "timer danger"
          } else if (remaining < 600) { // 10 –º–∏–Ω—É—Ç
            timerElement.className = "timer warning"
          }
        }
      }
      
      timerInterval = setInterval(updateTimer, 1000)
      updateTimer()
    }

    async function autoSubmit() {
      if (!task || !attemptStarted) return

      let answers = {}
      
      if (task.type === 'mcq') {
        const questions = task.content?.questions || []
        
        for (let i = 0; i < questions.length; i++) {
          const selected = document.querySelector(`input[name="q${i}"]:checked`)
          // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º -1 –¥–ª—è –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤–º–µ—Å—Ç–æ 0
          answers[i] = selected ? parseInt(selected.value) : -1
        }
      }

      try {
        const { data, error } = await supabase.rpc('finish_attempt', {
          _user_id: user.id,
          _task_id: taskId,
          _attempt_id: currentAttemptId,
          _answers: answers
        })

        if (error) {
          console.error('Auto-submit error:', error)
          return
        }

        const result = Array.isArray(data) ? data[0] : data
        
        if (result.error) {
          console.error('Auto-submit result error:', result.error)
        } else {
          taskBody.style.display = 'none'
          submitBtn.style.display = 'none'
          completedMessage.style.display = 'block'
          completedText.textContent = result.message || '‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ó–∞–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'
        }
      } catch (e) {
        console.error('Auto-submission error:', e)
      }
    }

    async function startAttempt() {
      loadingElement.style.display = 'block'
      taskBody.style.display = 'none'
      submitBtn.style.display = 'none'

      try {
        const { data, error } = await supabase.rpc('start_attempt', {
          _user_id: user.id,
          _task_id: taskId
        })

        if (error) throw error

        if (data.error) {
          showModal('–û—à–∏–±–∫–∞', data.error)
          return false
        }

        currentAttemptId = data.attempt_id
        attemptStarted = true
        startTime = new Date()
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
        timeInfo.style.display = 'block'
        timeInfo.innerHTML = `<strong>‚è±Ô∏è –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏:</strong> ${timeLimit} –º–∏–Ω—É—Ç. –¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω!`
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–¥–∞–Ω–∏—è
        loadingElement.style.display = 'none'
        taskBody.style.display = 'block'
        submitBtn.style.display = 'inline-block'
        attemptWarning.style.display = 'block'
        attemptWarning.innerHTML = '<strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í—ã –Ω–∞—á–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è. –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∞. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º!'
        timerElement.style.display = 'inline-block'
        
        startCountdown()
        renderTask()
        return true
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–ø—ã—Ç–∫–∏:', error)
        if (error.message.includes('–ü–æ–ø—ã—Ç–∫–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞')) {
          await showCompletedAttempt()
        } else {
          showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
        }
        return false
      }
    }

    async function showCompletedAttempt() {
      const { data: attempt } = await supabase
        .from('attempts')
        .select('*')
        .eq('task_id', taskId)
        .eq('user_id', user.id)
        .single()

      if (attempt) {
        loadingElement.style.display = 'none'
        taskBody.style.display = 'none'
        submitBtn.style.display = 'none'
        completedMessage.style.display = 'block'
        
        if (attempt.score === -1) {
          completedText.textContent = '–í—ã –Ω–∞—á–∞–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –µ–≥–æ. –ü–æ–ø—ã—Ç–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram: @skebobingg'
        } else if (attempt.score >= task.passing_score) {
          completedText.textContent = `‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ! –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${attempt.score}%`
        } else {
          completedText.textContent = `‚ùå –í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${attempt.score}%. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram: @skebobingg`
        }
      }
    }

    async function loadTask() {
      const { data: { user: userData } } = await supabase.auth.getUser()
      user = userData
      if (!user) {
        location.href = '/login.html'
        return
      }

      const { data: taskData } = await supabase.from('tasks').select('*').eq('id', taskId).single()
      if (!taskData) {
        showModal('–û—à–∏–±–∫–∞', '–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')
        return
      }
      
      task = taskData
      timeLimit = task.time_limit || 60
      
      const { data: key } = await supabase
        .from('keys')
        .select('*')
        .eq('user_id', user.id)
        .eq('month_index', task.month_index)
        .single()
      
      if (key) {
        showCompletedAttempt()
        completedText.textContent = 'üéâ –í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –∫–ª—é—á –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü!'
        return
      }

      document.getElementById('pageTitle').textContent = task.title
      document.getElementById('subTitle').textContent = `–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${task.passing_score || 80}% ‚Ä¢ –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏: ${timeLimit} –º–∏–Ω`

      const { data: attempt } = await supabase
        .from('attempts')
        .select('*')
        .eq('task_id', taskId)
        .eq('user_id', user.id)
        .single()

      if (attempt) {
        await showCompletedAttempt()
      } else {
        await startAttempt()
      }
    }

    function renderTask() {
      taskBody.innerHTML = ''
      
      if (task.type === 'mcq') {
        const questions = task.content?.questions || []
        
        questions.forEach((q, i) => {
          const questionEl = document.createElement('div')
          questionEl.className = 'question'
          
          let questionHTML = `<p><b>${i + 1}. ${escapeHtml(q.q)}</b></p>`
          
          if (q.image) {
            questionHTML += `
              <div class="question-image-container">
                <img src="${q.image}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞" 
                     class="question-image" 
                     onerror="this.style.display='none'">
              </div>
            `
          }
          
          questionHTML += `<div class="options">
            ${q.options.map((opt, j) => `
              <label class="option">
                <input type="radio" name="q${i}" value="${j}">
                <span>${escapeHtml(opt)}</span>
              </label>
            `).join('')}
          </div>`
          
          questionEl.innerHTML = questionHTML
          taskBody.appendChild(questionEl)
        })
      }

      submitBtn.onclick = submitAnswers
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    async function submitAnswers() {
      if (!task || !attemptStarted) return

      let answers = {}
      
      if (task.type === 'mcq') {
        const questions = task.content?.questions || []
        
        for (let i = 0; i < questions.length; i++) {
          const selected = document.querySelector(`input[name="q${i}"]:checked`)
          answers[i] = selected ? parseInt(selected.value) : null
          
          if (answers[i] === null) {
            showModal('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.')
            return
          }
        }
      }

      try {
        submitBtn.disabled = true
        submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç—ã...'
        
        const { data, error } = await supabase.rpc('finish_attempt', {
          _user_id: user.id,
          _task_id: taskId,
          _attempt_id: currentAttemptId,
          _answers: answers
        })

        if (error) {
          console.error('RPC Error:', error)
          showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
          submitBtn.disabled = false
          submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç'
          return
        }

        clearInterval(timerInterval)

        const result = Array.isArray(data) ? data[0] : data
        
        if (result.error) {
          showModal('–û—à–∏–±–∫–∞', result.error)
        } else if (result.passed) {
          taskBody.style.display = 'none'
          submitBtn.style.display = 'none'
          completedMessage.style.display = 'block'
          completedText.textContent = result.message
        } else {
          taskBody.style.display = 'none'
          submitBtn.style.display = 'none'
          completedMessage.style.display = 'block'
          completedText.textContent = result.message
        }
      } catch (e) {
        console.error('Submission error:', e)
        showModal('–û—à–∏–±–∫–∞', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
        submitBtn.disabled = false
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç'
      }
    }

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('beforeunload', (event) => {
      if (attemptStarted && submitBtn.style.display !== 'none' && !submitBtn.disabled) {
        event.preventDefault()
        event.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–π—Ç–∏?'
      }
    })

    document.addEventListener('DOMContentLoaded', loadTask)
  </script>
</body>
</html>