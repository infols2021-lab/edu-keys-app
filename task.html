<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ó–∞–¥–∞–Ω–∏–µ</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="centered">
  <div class="card" style="width:760px; max-width:95vw;">
    <h2 id="taskTitle">–ó–∞–¥–∞–Ω–∏–µ</h2>
    <div id="taskMeta" style="font-size:14px;color:#666;margin-bottom:8px;"></div>
    <div id="taskContent" style="text-align:left; margin:12px 0;"></div>
    <div style="display:flex; gap:12px; justify-content:space-between; align-items:center;">
      <div>
        <button id="submitBtn" class="btn">–°–¥–∞—Ç—å</button>
        <button id="tryAgainBtn" class="btn secondary" style="display:none">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      </div>
      <div>
        <button onclick="window.location.href='/tasks.html'" class="btn secondary">–ù–∞–∑–∞–¥ –∫ –∑–∞–¥–∞–Ω–∏—è–º</button>
      </div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç / –æ—à–∏–±–∫–∏ -->
  <div id="resultModal" class="modal">
    <div class="modal-content">
      <h3 id="resultTitle"></h3>
      <p id="resultText"></p>
      <div style="margin-top:10px;">
        <button id="closeModal" class="btn">OK</button>
      </div>
    </div>
  </div>

  <script src="/config.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY)

    const params = new URLSearchParams(window.location.search)
    const taskId = params.get('id')
    let task = null, user = null

    const submitBtn = document.getElementById('submitBtn')
    const tryAgainBtn = document.getElementById('tryAgainBtn')

    async function loadTask() {
      try {
        const { data: userData } = await supabase.auth.getUser()
        user = userData?.user
        if (!user) return redirectToLogin()

        if (!taskId) {
          showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–∫–∞–∑–∞–Ω ID –∑–∞–¥–∞–Ω–∏—è.')
          return
        }

        const { data, error } = await supabase
          .from('tasks')
          .select('id,title,type,content,passing_score,month_index,month_name')
          .eq('id', taskId)
          .single()

        if (error) throw error
        task = data
        // –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: content –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
        if (task && typeof task.content === 'string') {
          try { task.content = JSON.parse(task.content) } catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å content', e) }
        }

        document.getElementById('taskTitle').textContent = task.title
        document.getElementById('taskMeta').textContent = `${task.month_name || ('–ú–µ—Å—è—Ü ' + task.month_index)} ‚Äî –ü—Ä–æ—Ö–æ–¥–Ω–æ–π: ${task.passing_score}%`

        renderTask(task)
      } catch (err) {
        console.error(err)
        showModal('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', err.message || String(err))
      }
    }

    function redirectToLogin(){
      window.location.href = '/login.html'
    }

    function renderTask(task) {
      const container = document.getElementById('taskContent')
      container.innerHTML = ''
      if (task.type === 'mcq') {
        const qlist = task.content?.questions || []
        qlist.forEach((q, i) => {
          const qEl = document.createElement('div')
          qEl.style.padding = '8px'
          qEl.style.borderBottom = '1px dashed #eee'
          qEl.innerHTML = `<p style="margin:6px 0"><b>${i+1}. ${escapeHtml(q.q)}</b> <span style="color:#666">(${q.points ?? 1} –±–∞–ª–ª)</span></p>`
          const opts = q.options || []
          opts.forEach((opt, j) => {
            const id = `q${i}_opt${j}`
            qEl.innerHTML += `<div style="margin:4px 0"><label><input type="radio" name="q${i}" id="${id}" value="${j}"> ${escapeHtml(opt)}</label></div>`
          })
          container.appendChild(qEl)
        })
      } else if (task.type === 'fill') {
        const text = task.content?.text || '...'
        const html = escapeHtml(text).replace('____', `<input id="fillAnswer" style="padding:6px;border-radius:8px;border:1px solid #ddd;width:220px">`)
        container.innerHTML = `<div style="padding:8px">${html}</div>`
      } else if (task.type === 'crossword') {
        const img = task.content?.image || ''
        const html = `
          <div style="padding:8px">
            <img src="${escapeAttr(img)}" alt="–ö—Ä–æ—Å—Å–≤–æ—Ä–¥" style="width:100%;max-width:640px;border-radius:12px;border:3px solid #ffd3a5"/>
            <p style="margin-top:8px">–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ-–∫–ª—é—á:</p>
            <input id="crossAnswer" style="padding:6px;border-radius:8px;border:1px solid #ddd;width:220px">
          </div>`
        container.innerHTML = html
      } else {
        container.innerHTML = `<div style="padding:8px"><i>–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è: ${escapeHtml(task.type)}</i></div>`
      }
    }

    submitBtn.addEventListener('click', async () => {
      if (!task || !user) {
        showModal('–û—à–∏–±–∫–∞', '–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–ª–∏ –≤—ã –Ω–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.')
        return
      }
      submitBtn.disabled = true
      try {
        // —Å–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
        const answers = {}
        if (task.type === 'mcq') {
          const qs = task.content?.questions || []
          qs.forEach((q, i) => {
            const sel = document.querySelector(`input[name="q${i}"]:checked`)
            if (sel) answers[i] = sel.value
            else answers[i] = null
          })
        } else if (task.type === 'fill') {
          const v = document.getElementById('fillAnswer')?.value ?? ''
          answers[0] = v
        } else if (task.type === 'crossword') {
          const v = document.getElementById('crossAnswer')?.value ?? ''
          answers[0] = v
        }

        // –í—ã–∑–æ–≤ RPC. supabase-js –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç JS-–æ–±—ä–µ–∫—Ç –≤ jsonb.
        const { data, error } = await supabase
          .rpc('check_task_and_issue_key', {
            _user_id: user.id,
            _task_id: task.id,
            _answers: answers
          })

        if (error) throw error

        // data ‚Äî JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏
        // –∏–Ω–æ–≥–¥–∞ supabase –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ data (–≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ -> data[0])
        const result = (Array.isArray(data) && data.length>0) ? data[0] : data

        showResultModal(result)
      } catch (err) {
        console.error('submit error', err)
        showModal('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ', err.message || String(err))
      } finally {
        submitBtn.disabled = false
      }
    })

    function showResultModal(resultObj) {
      if (!resultObj) return showModal('–û—à–∏–±–∫–∞', '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞')
      const passed = resultObj.passed === true || resultObj.passed === 't'
      const score = resultObj.score ?? resultObj.data?.score
      if (passed) {
        showModal('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º üéâ', `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${score}% –∏ –ø–æ–ª—É—á–∏–ª–∏ –∫–ª—é—á!`)
      } else {
        showModal('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞', `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${score}% (–Ω—É–∂–Ω–æ ${resultObj.need}%)`, true)
      }
    }

    function showModal(title, text, allowRetry=false) {
      document.getElementById('resultTitle').textContent = title
      document.getElementById('resultText').textContent = text
      document.getElementById('resultModal').classList.add('active')
      if (allowRetry) {
        tryAgainBtn.style.display = 'inline-block'
      } else {
        tryAgainBtn.style.display = 'none'
      }
    }

    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('resultModal').classList.remove('active')
      // –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞–Ω–∏–π
      window.location.href = '/tasks.html'
    })
    tryAgainBtn.addEventListener('click', () => {
      document.getElementById('resultModal').classList.remove('active')
      tryAgainBtn.style.display = 'none'
    })

    // utils
    function escapeHtml(s) {
      if (s == null) return ''
      return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))
    }
    function escapeAttr(s){ return escapeHtml(s) }

    loadTask()
  </script>
</body>
</html>
