<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω ‚Äî Edu Keys</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1200px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { margin-bottom:15px; }
    .search-container input { width:100%; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    .time-limit-info { background:#e7f3ff; border:1px solid #b3d9ff; border-radius:8px; padding:10px; margin-top:5px; font-size:14px; }
    .question-type-selector { display:flex; gap:10px; margin-bottom:15px; }
    .type-btn { padding:10px 15px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:white; transition:all 0.3s; }
    .type-btn.active { border-color:var(--accent2); background:var(--accent2); color:white; }
    .fill-answer { padding:8px 12px; border:2px solid rgba(0,0,0,0.1); border-radius:8px; font-size:16px; width:100%; margin-top:5px; }
    .task-stats { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .task-type-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
    .mcq-type { background: #e3f2fd; color: #1976d2; }
    .fill-type { background: #f3e5f5; color: #7b1fa2; }
    .mixed-type { background: #e8f5e8; color: #2e7d32; }
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
    .config-loading { 
      text-align: center; 
      padding: 40px; 
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="task-stats">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div>
            <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>
            <span id="totalTasks">–ó–∞–¥–∞–Ω–∏–π: 0</span> | 
            <span id="totalUsers">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 0</span>
          </div>
          <div>
            <strong>üéØ –¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤:</strong>
            <span class="task-type-indicator mcq-type">üìù –¢–µ—Å—Ç</span>
            <span class="task-type-indicator fill-type">‚úçÔ∏è –ü–∏—Å—å–º–µ–Ω–Ω—ã–π</span>
            <span class="task-type-indicator mixed-type">üìù+‚úçÔ∏è –°–º–µ—à–∞–Ω–Ω—ã–π</span>
          </div>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="admin-tab" data-tab="tasks">üìö –ó–∞–¥–∞–Ω–∏—è</div>
      </div>

      <div class="admin-section active" id="users-section">
        <div class="card">
          <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." class="input">
          </div>
          <table class="admin-table" id="usersTable">
            <thead>
              <tr>
                <th>–§–ò–û</th>
                <th>Email</th>
                <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="admin-section" id="tasks-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</h2>
          <button class="btn" id="createTaskBtn">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
          <table class="admin-table" id="tasksTable">
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ú–µ—Å—è—Ü</th>
                <th>–¢–∏–ø</th>
                <th>–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏</th>
                <th>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" id="taskFormCard" style="display:none;">
          <h2 id="formTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
          
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:</label>
            <input type="text" id="taskTitle" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          
          <div class="form-group">
            <label>–ú–µ—Å—è—Ü:</label>
            <select id="taskMonth" class="input">
              <option value="1">–°–µ–Ω—Ç—è–±—Ä—å</option>
              <option value="2">–û–∫—Ç—è–±—Ä—å</option>
              <option value="3">–ù–æ—è–±—Ä—å</option>
              <option value="4">–î–µ–∫–∞–±—Ä—å</option>
              <option value="5">–Ø–Ω–≤–∞—Ä—å</option>
              <option value="6">–§–µ–≤—Ä–∞–ª—å</option>
              <option value="7">–ú–∞—Ä—Ç</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω—É—Ç—ã):</label>
            <input type="number" id="taskTimeLimit" class="input" value="60" min="1" max="240">
            <div class="time-limit-info">‚è∞ –£—á–µ–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</div>
          </div>
          
          <div class="form-group">
            <label>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª (%):</label>
            <input type="number" id="taskPassingScore" class="input" value="80" min="0" max="100">
          </div>
          
          <div id="taskContent">
            <h3>–í–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞–Ω–∏—è</h3>
            <div class="question-type-selector">
              <div class="type-btn active" data-type="mcq">üìù –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</div>
              <div class="type-btn" data-type="fill">‚úçÔ∏è –í–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç</div>
            </div>
            <div id="questionsContainer">
              <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button class="btn btn-small" id="addQuestionBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          </div>
          
          <div style="margin-top:20px;">
            <button class="btn" id="saveTaskBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
            <button class="btn secondary" id="cancelTaskBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">–û–ö</button>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('configLoading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let editingTaskId = null;
        let currentQuestionType = 'mcq';
        let questionCounter = 0;
        let searchTimeout = null;

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('modalOk').addEventListener('click', () => {
          document.getElementById('modal').style.display = 'none';
        });

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        });

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        document.getElementById('userSearch').addEventListener('input', function(e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏
        document.getElementById('createTaskBtn').addEventListener('click', showTaskForm);
        document.getElementById('cancelTaskBtn').addEventListener('click', hideTaskForm);
        document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
        document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);

        // –¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤
        document.querySelectorAll('.type-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentQuestionType = this.getAttribute('data-type');
          });
        });

        // –í–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∏ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
            tab.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
          });
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function checkAdmin() {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            window.location.href = '/login.html';
            return false;
          }
          
          const { data: profile } = await supabase
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();
            
          if (!profile || !profile.is_admin) {
            showModal('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            setTimeout(() => {
              window.location.href = '/profile.html';
            }, 2000);
            return false;
          }
          
          currentUser = user;
          return true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Supabase Storage
        async function uploadQuestionImage(file, questionIndex) {
          try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `questions/${fileName}`;
            
            const { data, error } = await supabase.storage
              .from('task-images')
              .upload(filePath, file);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabase.storage
              .from('task-images')
              .getPublicUrl(filePath);
            
            return publicUrl;
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + error.message);
          }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
          try {
            // –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞–Ω–∏—è
            const { data: tasks, error: tasksError } = await supabase
              .from('tasks')
              .select('id, content');
            
            // –°—á–∏—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const { data: users, error: usersError } = await supabase
              .from('profiles')
              .select('id');

            if (!tasksError && !usersError) {
              document.getElementById('totalTasks').textContent = `–ó–∞–¥–∞–Ω–∏–π: ${tasks.length}`;
              document.getElementById('totalUsers').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`;
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
          }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function initAdmin() {
          const isAdmin = await checkAdmin();
          if (!isAdmin) return;
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          loadUsers();
          loadTasks();
          loadStats();
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
          addQuestion('mcq');
        }
        
        // ===== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò =====
        async function loadUsers() {
          const searchTerm = document.getElementById('userSearch').value.trim();
          
          let query = supabase
            .from('profiles')
            .select(`
              *,
              attempts:attempts(count),
              keys:keys(count)
            `)
            .order('created_at', { ascending: false });
          
          if (searchTerm) {
            query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
          }
          
          const { data, error } = await query;
          
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = '';
          
          if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center;padding:20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          data.forEach(user => {
            const attemptsCount = user.attempts?.[0]?.count || 0;
            const keysCount = user.keys?.[0]?.count || 0;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong></div>
                <div class="user-stats">
                  <span class="stat-badge">üë§ ID: ${user.id.substring(0, 8)}...</span>
                </div>
              </td>
              <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
              <td>
                <div class="user-stats">
                  <span class="stat-badge">üóùÔ∏è ${keysCount} –∫–ª—é—á–µ–π</span>
                  <span class="stat-badge">üìä ${attemptsCount} –ø–æ–ø—ã—Ç–æ–∫</span>
                </div>
              </td>
              <td>${user.is_admin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${user.is_admin ? 'secondary' : ''}" data-user-id="${user.id}" data-make-admin="${!user.is_admin}">
                    ${user.is_admin ? '‚ùå –£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∫—É' : 'üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º'}
                  </button>
                  <button class="btn btn-small btn-warning" data-user-id="${user.id}" data-user-email="${user.email}">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
          document.querySelectorAll('[data-user-id]').forEach(btn => {
            if (btn.textContent.includes('–∞–¥–º–∏–Ω')) {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const makeAdmin = btn.getAttribute('data-make-admin') === 'true';
                toggleAdmin(userId, makeAdmin);
              });
            } else {
              btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const userEmail = btn.getAttribute('data-user-email');
                resetProgress(userId, userEmail);
              });
            }
          });
        }
        
        async function toggleAdmin(userId, makeAdmin) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${makeAdmin ? '–Ω–∞–∑–Ω–∞—á–∏—Ç—å' : '—Å–Ω—è—Ç—å'} –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?`)) return;
          
          const { error } = await supabase
            .from('profiles')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);
            
          if (error) {
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤: ' + error.message);
          } else {
            loadUsers();
          }
        }
        
        async function resetProgress(userId, userEmail) {
          if (!confirm(`–í–´ –£–í–ï–†–ï–ù–´, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n‚Ä¢ –£–¥–∞–ª–∏—Ç –í–°–ï –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –£–¥–∞–ª–∏—Ç –í–°–ï –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –°–±—Ä–æ—Å–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n‚Ä¢ –ù–ï–õ–¨–ó–Ø –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;
          
          try {
            const { data, error } = await supabase.rpc('reset_user_progress', {
              _user_id: userId
            });
            
            if (error) {
              console.error('RPC Error:', error);
              showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message);
              return;
            }
            
            if (data.error) {
              showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + data.message);
            } else {
              showModal('–£—Å–ø–µ—Ö', '‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω!\n\n–£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–∏ –∏ –ø–æ–ø—ã—Ç–∫–∏.');
              loadUsers();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message);
          }
        }

        // ===== –†–ê–ë–û–¢–ê –° –ó–ê–î–ê–ù–ò–Ø–ú–ò =====
        async function loadTasks() {
          const { data, error } = await supabase
            .from('tasks')
            .select('*')
            .order('month_index', { ascending: true });
          
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#tasksTable tbody');
          tbody.innerHTML = '';
          
          if (!data || data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="text-align:center;padding:20px;">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          const months = ["–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å", "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç"];
          
          data.forEach(task => {
            const questionTypes = task.content?.questions?.map(q => q.type) || [];
            const hasMcq = questionTypes.includes('mcq');
            const hasFill = questionTypes.includes('fill');
            
            let typeText = '';
            let typeClass = '';
            if (hasMcq && hasFill) {
              typeText = 'üìù+‚úçÔ∏è';
              typeClass = 'mixed-type';
            } else if (hasMcq) {
              typeText = 'üìù';
              typeClass = 'mcq-type';
            } else if (hasFill) {
              typeText = '‚úçÔ∏è';
              typeClass = 'fill-type';
            } else {
              typeText = 'üìù';
              typeClass = 'mcq-type';
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${task.title}</td>
              <td>${months[task.month_index - 1] || task.month_index}</td>
              <td>
                <span class="task-type-indicator ${typeClass}">${typeText}</span>
              </td>
              <td>${task.time_limit || 60} –º–∏–Ω</td>
              <td>${task.passing_score}%</td>
              <td>
                <button class="btn btn-small edit-task" data-task-id="${task.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-small btn-danger delete-task" data-task-id="${task.id}" data-task-title="${task.title}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–¥–∞–Ω–∏–π
          document.querySelectorAll('.edit-task').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              editTask(taskId);
            });
          });

          document.querySelectorAll('.delete-task').forEach(btn => {
            btn.addEventListener('click', () => {
              const taskId = btn.getAttribute('data-task-id');
              const taskTitle = btn.getAttribute('data-task-title');
              deleteTask(taskId, taskTitle);
            });
          });
        }
        
        function showTaskForm() {
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
          document.getElementById('taskTitle').value = '';
          document.getElementById('taskMonth').value = '1';
          document.getElementById('taskTimeLimit').value = '60';
          document.getElementById('taskPassingScore').value = '80';
          editingTaskId = null;
          questionCounter = 0;
          
          // –û—á–∏—â–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
          const questionsContainer = document.getElementById('questionsContainer');
          questionsContainer.innerHTML = '';
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
          addQuestion('mcq');
        }
        
        function hideTaskForm() {
          document.getElementById('taskFormCard').style.display = 'none';
        }
        
        function setupUploadArea(questionIndex) {
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          if (!uploadArea) return;
          
          const imageInput = document.getElementById(`imageInput${questionIndex}`);
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop
          uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });
          
          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
          });
          
          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              imageInput.files = files;
              handleImageUpload(imageInput, questionIndex);
            }
          });
        }
        
        function handleImageUpload(input, questionIndex) {
          const file = input.files[0];
          if (!file) return;
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
          if (!file.type.match('image.*')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!');
            return;
          }
          
          const progress = document.getElementById(`progress${questionIndex}`);
          const progressBar = document.getElementById(`progressBar${questionIndex}`);
          const preview = document.getElementById(`imagePreview${questionIndex}`);
          const removeBtn = document.getElementById(`removeBtn${questionIndex}`);
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          progress.style.display = 'block';
          progressBar.style.width = '0%';
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          uploadQuestionImage(file, questionIndex)
            .then(imageUrl => {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ
              document.getElementById(`imageUrl${questionIndex}`).value = imageUrl;
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
              preview.src = imageUrl;
              preview.style.display = 'block';
              removeBtn.style.display = 'block';
              uploadArea.style.display = 'none';
              progressBar.style.width = '100%';
              
              setTimeout(() => {
                progress.style.display = 'none';
              }, 1000);
            })
            .catch(error => {
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
              progress.style.display = 'none';
            });
        }
        
        function removeImage(questionIndex) {
          const preview = document.getElementById(`imagePreview${questionIndex}`);
          const removeBtn = document.getElementById(`removeBtn${questionIndex}`);
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          const imageUrlInput = document.getElementById(`imageUrl${questionIndex}`);
          const imageInput = document.getElementById(`imageInput${questionIndex}`);
          
          preview.style.display = 'none';
          removeBtn.style.display = 'none';
          uploadArea.style.display = 'block';
          imageUrlInput.value = '';
          imageInput.value = '';
        }
        
        function addQuestion(type = null) {
          const questionsContainer = document.getElementById('questionsContainer');
          const questionType = type || currentQuestionType;
          questionCounter++;
          
          const newQuestion = document.createElement('div');
          newQuestion.className = 'subtask-item';
          newQuestion.setAttribute('data-type', questionType);
          
          if (questionType === 'mcq') {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <input type="text" class="input question-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
              </div>
              <div class="form-group">
                <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <div class="upload-area" id="uploadArea${questionCounter}">
                  <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                  <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                  <input type="file" id="imageInput${questionCounter}" style="display:none" accept="image/*">
                </div>
                <div class="upload-progress" id="progress${questionCounter}">
                  <div class="upload-progress-bar" id="progressBar${questionCounter}"></div>
                </div>
                <input type="hidden" class="input question-image" id="imageUrl${questionCounter}">
                <img class="image-preview" id="imagePreview${questionCounter}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionCounter}" style="display:none; margin-top:5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
              </div>
              <div class="form-group">
                <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                <textarea class="input mcq-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                <input type="number" class="input mcq-correct" min="1" value="1">
              </div>
              <button class="btn btn-small btn-danger remove-question">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            `;
          } else {
            newQuestion.innerHTML = `
              <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <input type="text" class="input question-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
              </div>
              <div class="form-group">
                <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <div class="upload-area" id="uploadArea${questionCounter}">
                  <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                  <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                  <input type="file" id="imageInput${questionCounter}" style="display:none" accept="image/*">
                </div>
                <div class="upload-progress" id="progress${questionCounter}">
                  <div class="upload-progress-bar" id="progressBar${questionCounter}"></div>
                </div>
                <input type="hidden" class="input question-image" id="imageUrl${questionCounter}">
                <img class="image-preview" id="imagePreview${questionCounter}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionCounter}" style="display:none; margin-top:5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
              </div>
              <div class="form-group">
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                <input type="text" class="input fill-answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç">
              </div>
              <button class="btn btn-small btn-danger remove-question">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            `;
          }
          
          questionsContainer.appendChild(newQuestion);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
          const uploadArea = document.getElementById(`uploadArea${questionCounter}`);
          const imageInput = document.getElementById(`imageInput${questionCounter}`);
          const removeBtn = document.getElementById(`removeBtn${questionCounter}`);
          const removeQuestionBtn = newQuestion.querySelector('.remove-question');
          
          uploadArea.addEventListener('click', () => imageInput.click());
          imageInput.addEventListener('change', () => handleImageUpload(imageInput, questionCounter));
          removeBtn.addEventListener('click', () => removeImage(questionCounter));
          removeQuestionBtn.addEventListener('click', function() {
            if (document.querySelectorAll('.subtask-item').length > 1) {
              newQuestion.remove();
            } else {
              alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            }
          });
          
          setupUploadArea(questionCounter);
        }
        
        async function editTask(taskId) {
          const { data: task, error } = await supabase
            .from('tasks')
            .select('*')
            .eq('id', taskId)
            .single();
            
          if (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
            return;
          }
          
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
          document.getElementById('taskTitle').value = task.title;
          document.getElementById('taskMonth').value = task.month_index;
          document.getElementById('taskTimeLimit').value = task.time_limit || 60;
          document.getElementById('taskPassingScore').value = task.passing_score;
          editingTaskId = taskId;
          questionCounter = 0;
          
          // –û—á–∏—â–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
          const questionsContainer = document.getElementById('questionsContainer');
          questionsContainer.innerHTML = '';
          
          // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∑–∞–¥–∞–Ω–∏—è
          const questions = task.content?.questions || [];
          questions.forEach((q, i) => {
            questionCounter++;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'subtask-item';
            questionDiv.setAttribute('data-type', q.type || 'mcq');
            
            if (q.type === 'fill') {
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                  <input type="text" class="input question-text" value="${q.q || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                </div>
                <div class="form-group">
                  <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                  <div class="upload-area" id="uploadArea${questionCounter}" style="${q.image ? 'display:none' : ''}">
                    <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="imageInput${questionCounter}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="progress${questionCounter}">
                    <div class="upload-progress-bar" id="progressBar${questionCounter}"></div>
                  </div>
                  <input type="hidden" class="input question-image" id="imageUrl${questionCounter}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionCounter}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionCounter}" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
                <div class="form-group">
                  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                  <input type="text" class="input fill-answer" value="${q.answer || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç">
                </div>
                <button class="btn btn-small btn-danger remove-question">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              `;
            } else {
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                  <input type="text" class="input question-text" value="${q.q || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                </div>
                <div class="form-group">
                  <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                  <div class="upload-area" id="uploadArea${questionCounter}" style="${q.image ? 'display:none' : ''}">
                    <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="imageInput${questionCounter}" style="display:none" accept="image/*">
                  </div>
                  <div class="upload-progress" id="progress${questionCounter}">
                    <div class="upload-progress-bar" id="progressBar${questionCounter}"></div>
                  </div>
                  <input type="hidden" class="input question-image" id="imageUrl${questionCounter}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionCounter}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" id="removeBtn${questionCounter}" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
                <div class="form-group">
                  <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                  <textarea class="input mcq-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3" rows="3">${(q.options || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                  <input type="number" class="input mcq-correct" min="1" value="${(q.correct || 0) + 1}">
                </div>
                <button class="btn btn-small btn-danger remove-question">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              `;
            }
            
            questionsContainer.appendChild(questionDiv);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            const uploadArea = document.getElementById(`uploadArea${questionCounter}`);
            const imageInput = document.getElementById(`imageInput${questionCounter}`);
            const removeBtn = document.getElementById(`removeBtn${questionCounter}`);
            const removeQuestionBtn = questionDiv.querySelector('.remove-question');
            
            if (uploadArea) {
              uploadArea.addEventListener('click', () => imageInput.click());
              imageInput.addEventListener('change', () => handleImageUpload(imageInput, questionCounter));
            }
            if (removeBtn) {
              removeBtn.addEventListener('click', () => removeImage(questionCounter));
            }
            removeQuestionBtn.addEventListener('click', function() {
              if (document.querySelectorAll('.subtask-item').length > 1) {
                questionDiv.remove();
              } else {
                alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
              }
            });
            
            setupUploadArea(questionCounter);
          });
        }
        
        async function saveTask() {
          const title = document.getElementById('taskTitle').value;
          const monthIndex = parseInt(document.getElementById('taskMonth').value);
          const timeLimit = parseInt(document.getElementById('taskTimeLimit').value);
          const passingScore = parseInt(document.getElementById('taskPassingScore').value);
          
          if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è');
            return;
          }
          
          const questions = [];
          const questionElements = document.querySelectorAll('.subtask-item');
          
          if (questionElements.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            return;
          }
          
          for (let i = 0; i < questionElements.length; i++) {
            const item = questionElements[i];
            const questionType = item.getAttribute('data-type') || 'mcq';
            const question = item.querySelector('.question-text').value;
            const imageUrl = document.getElementById(`imageUrl${i + 1}`)?.value || '';
            
            if (!question) {
              alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞');
              return;
            }
            
            if (questionType === 'mcq') {
              const optionsText = item.querySelector('.mcq-options').value;
              const correct = parseInt(item.querySelector('.mcq-correct').value) - 1;
              
              const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
              
              if (correct < 0 || correct >= options.length) {
                alert('–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–¥–Ω–æ–º—É –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
                return;
              }
              
              questions.push({
                type: 'mcq',
                q: question,
                image: imageUrl || null,
                options: options,
                correct: correct
              });
            } else {
              const answer = item.querySelector('.fill-answer').value;
              
              if (!answer) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ —Å –≤–≤–æ–¥–æ–º —Ç–µ–∫—Å—Ç–∞');
                return;
              }
              
              questions.push({
                type: 'fill',
                q: question,
                image: imageUrl || null,
                answer: answer
              });
            }
          }
          
          const content = { questions };
          
          // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
          const hasMcq = questions.some(q => q.type === 'mcq');
          const hasFill = questions.some(q => q.type === 'fill');
          
          let taskType = 'mcq';
          if (hasMcq && hasFill) {
            taskType = 'mixed';
          } else if (hasFill) {
            taskType = 'fill';
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ
          try {
            if (editingTaskId) {
              const { error } = await supabase
                .from('tasks')
                .update({ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: taskType,
                  passing_score: passingScore, 
                  content 
                })
                .eq('id', editingTaskId);
                
              if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
              } else {
                alert('–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                hideTaskForm();
                loadTasks();
              }
            } else {
              const { error } = await supabase
                .from('tasks')
                .insert([{ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: taskType,
                  passing_score: passingScore, 
                  content 
                }]);
                
              if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
              } else {
                alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
                hideTaskForm();
                loadTasks();
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
          }
        }
        
        async function deleteTask(taskId, taskTitle) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ "${taskTitle}"?\n\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;
          
          try {
            const { error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
              
            if (error) {
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
            } else {
              alert('–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
              loadTasks();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
          }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        await initAdmin();
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: ' + error.message);
        return false;
      }
    }
    
    const configTimeout = setTimeout(() => {
      if (!window.SUPABASE_URL) {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è...');
        window.SUPABASE_URL = 'https://dtjhlanmwjpdcdxgzzyo.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0amhsYW5td2pwZGNkeGd6enlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDUwOTIsImV4cCI6MjA3MjM4MTA5Mn0.jS4DXQSOBawRFtnzjsmF5AzzltDYAG0AXrwrY1B0UpY';
        initApp();
      }
    }, 5000);
    
    window.addEventListener('configLoaded', () => {
      clearTimeout(configTimeout);
      initApp();
    });
    
    if (window.SUPABASE_URL) {
      clearTimeout(configTimeout);
      initApp();
    }
  </script>
</body>
</html>