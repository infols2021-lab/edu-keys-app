<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω ‚Äî Edu Keys</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-container { width:95%; max-width:1200px; margin:20px auto; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:15px; background:var(--card); border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,0.08); }
    .admin-tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .admin-tab { padding:12px 20px; background:var(--card); border-radius:12px; cursor:pointer; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:all 0.2s; }
    .admin-tab.active { background:var(--accent2); color:white; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:15px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .admin-table th, .admin-table td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
    .admin-table th { background-color:var(--bg1); font-weight:700; }
    .admin-table tr:last-child td { border-bottom:none; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .subtask-item { background:var(--bg1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid rgba(0,0,0,0.1); }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-small { padding:6px 12px; font-size:14px; }
    .user-stats { display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; }
    .stat-badge { background:var(--bg1); padding:4px 8px; border-radius:6px; font-size:12px; }
    .user-actions { display:flex; flex-direction:column; gap:5px; }
    .search-container { display:flex; gap:10px; margin-bottom:15px; }
    .search-container input { flex:1; }
    .image-preview { max-width:200px; max-height:150px; border-radius:8px; margin:10px 0; display:none; }
    .upload-area { border:2px dashed #ccc; border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color 0.3s; margin:10px 0; }
    .upload-area:hover { border-color:var(--accent2); }
    .upload-area.dragover { border-color:var(--accent2); background-color:rgba(78,205,196,0.1); }
    .upload-progress { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; display:none; }
    .upload-progress-bar { height:100%; background:var(--accent2); border-radius:2px; width:0%; transition:width 0.3s; }
    .time-limit-info { background:#e7f3ff; border:1px solid #b3d9ff; border-radius:8px; padding:10px; margin-top:5px; font-size:14px; }
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
    .config-loading { 
      text-align: center; 
      padding: 40px; 
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="configLoading" class="config-loading">
    <div class="spinner"></div>
    <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <div>
          <button class="btn" onclick="location.href='/profile.html'">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="admin-tab" data-tab="tasks">üìö –ó–∞–¥–∞–Ω–∏—è</div>
      </div>

      <div class="admin-section active" id="users-section">
        <div class="card">
          <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
          <div class="search-container">
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." class="input">
            <button class="btn" onclick="loadUsers()">üîç –ü–æ–∏—Å–∫</button>
            <button class="btn secondary" onclick="clearSearch()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <table class="admin-table" id="usersTable">
            <thead>
              <tr>
                <th>–§–ò–û</th>
                <th>Email</th>
                <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="admin-section" id="tasks-section">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏</h2>
          <button class="btn" onclick="showTaskForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
          <table class="admin-table" id="tasksTable">
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ú–µ—Å—è—Ü</th>
                <th>–¢–∏–ø</th>
                <th>–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏</th>
                <th>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" id="taskFormCard" style="display:none;">
          <h2 id="formTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
          
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:</label>
            <input type="text" id="taskTitle" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          
          <div class="form-group">
            <label>–ú–µ—Å—è—Ü:</label>
            <select id="taskMonth" class="input">
              <option value="1">–°–µ–Ω—Ç—è–±—Ä—å</option>
              <option value="2">–û–∫—Ç—è–±—Ä—å</option>
              <option value="3">–ù–æ—è–±—Ä—å</option>
              <option value="4">–î–µ–∫–∞–±—Ä—å</option>
              <option value="5">–Ø–Ω–≤–∞—Ä—å</option>
              <option value="6">–§–µ–≤—Ä–∞–ª—å</option>
              <option value="7">–ú–∞—Ä—Ç</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω—É—Ç—ã):</label>
            <input type="number" id="taskTimeLimit" class="input" value="60" min="1" max="240">
            <div class="time-limit-info">‚è∞ –£—á–µ–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</div>
          </div>
          
          <div class="form-group">
            <label>–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è:</label>
            <select id="taskType" class="input" disabled>
              <option value="mcq">üìù –¢–µ—Å—Ç (–≤—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞)</option>
            </select>
            <div class="small-muted" style="margin-top:5px;">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è</div>
          </div>
          
          <div class="form-group">
            <label>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª (%):</label>
            <input type="number" id="taskPassingScore" class="input" value="80" min="0" max="100">
          </div>
          
          <div id="taskContent"></div>
          
          <div style="margin-top:20px;">
            <button class="btn" onclick="saveTask()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
            <button class="btn secondary" onclick="hideTaskForm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modal" style="display: none;">
    <div class="modal-body card">
      <h3 id="modalTitle"></h3>
      <p id="modalText" style="white-space: pre-line;"></p>
      <div style="margin-top: 12px; text-align: center;">
        <button class="btn" id="modalOk">–û–ö</button>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('configLoading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('configLoading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    function showModal(title, text) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modal').style.display = 'flex';
    }

    document.getElementById('modalOk').addEventListener('click', () => {
      document.getElementById('modal').style.display = 'none';
    });

    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let editingTaskId = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function checkAdmin() {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            window.location.href = '/login.html';
            return false;
          }
          
          const { data: profile } = await supabase
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();
            
          if (!profile || !profile.is_admin) {
            showModal('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            setTimeout(() => {
              window.location.href = '/profile.html';
            }, 2000);
            return false;
          }
          
          currentUser = user;
          return true;
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
          }
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–µ –≤—ã—Ö–æ–¥–∞
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Supabase Storage
        async function uploadQuestionImage(file, questionIndex) {
          try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            const filePath = `questions/${fileName}`;
            
            const { data, error } = await supabase.storage
              .from('task-images')
              .upload(filePath, file);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabase.storage
              .from('task-images')
              .getPublicUrl(filePath);
            
            return publicUrl;
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + error.message);
          }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function initAdmin() {
          const isAdmin = await checkAdmin();
          if (!isAdmin) return;
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          loadUsers();
          loadTasks();
          
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫
          document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              const tabName = tab.getAttribute('data-tab');
              
              // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∏ —Å–µ–∫—Ü–∏–∏
              document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
              
              // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
              tab.classList.add('active');
              document.getElementById(`${tabName}-section`).classList.add('active');
            });
          });
          
          // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
          document.getElementById('userSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              loadUsers();
            }
          });
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π
          renderTaskContent();
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
        function clearSearch() {
          document.getElementById('userSearch').value = '';
          loadUsers();
        }
        
        // ===== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò =====
        async function loadUsers() {
          const searchTerm = document.getElementById('userSearch').value.trim();
          
          let query = supabase
            .from('profiles')
            .select(`
              *,
              attempts:attempts(count),
              keys:keys(count)
            `)
            .order('created_at', { ascending: false });
          
          if (searchTerm) {
            query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
          }
          
          const { data, error } = await query;
          
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = '';
          
          if (data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center;padding:20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          data.forEach(user => {
            const attemptsCount = user.attempts?.[0]?.count || 0;
            const keysCount = user.keys?.[0]?.count || 0;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><strong>${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong></div>
                <div class="user-stats">
                  <span class="stat-badge">üë§ ID: ${user.id.substring(0, 8)}...</span>
                </div>
              </td>
              <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
              <td>
                <div class="user-stats">
                  <span class="stat-badge">üóùÔ∏è ${keysCount} –∫–ª—é—á–µ–π</span>
                  <span class="stat-badge">üìä ${attemptsCount} –ø–æ–ø—ã—Ç–æ–∫</span>
                </div>
              </td>
              <td>${user.is_admin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-small ${user.is_admin ? 'secondary' : ''}" onclick="toggleAdmin('${user.id}', ${!user.is_admin})">
                    ${user.is_admin ? '‚ùå –£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∫—É' : 'üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º'}
                  </button>
                  <button class="btn btn-small btn-warning" onclick="resetProgress('${user.id}', '${user.email}')">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                  <button class="btn btn-small btn-danger" onclick="deleteUser('${user.id}', '${user.email}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        window.toggleAdmin = async (userId, makeAdmin) => {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${makeAdmin ? '–Ω–∞–∑–Ω–∞—á–∏—Ç—å' : '—Å–Ω—è—Ç—å'} –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?`)) return;
          
          const { error } = await supabase
            .from('profiles')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);
            
          if (error) {
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤: ' + error.message);
          } else {
            loadUsers();
          }
        }
        
        window.resetProgress = async (userId, userEmail) => {
          if (!confirm(`–í–´ –£–í–ï–†–ï–ù–´, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n‚Ä¢ –£–¥–∞–ª–∏—Ç –í–°–ï –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –£–¥–∞–ª–∏—Ç –í–°–ï –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –°–±—Ä–æ—Å–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n‚Ä¢ –ù–ï–õ–¨–ó–Ø –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;
          
          try {
            const { data, error } = await supabase.rpc('reset_user_progress', {
              _user_id: userId
            });
            
            if (error) {
              console.error('RPC Error:', error);
              showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message);
              return;
            }
            
            if (data.error) {
              showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + data.message);
            } else {
              showModal('–£—Å–ø–µ—Ö', '‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω!\n\n–£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–∏ –∏ –ø–æ–ø—ã—Ç–∫–∏.');
              loadUsers();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message);
          }
        }
        
        window.deleteUser = async (userId, userEmail) => {
          if (!confirm(`üö® –í–´ –£–í–ï–†–ï–ù–´, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n‚Ä¢ –£–¥–∞–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã\n‚Ä¢ –£–¥–∞–ª–∏—Ç –í–°–ï –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (–∫–ª—é—á–∏, –ø–æ–ø—ã—Ç–∫–∏, –ø—Ä–æ—Ñ–∏–ª—å)\n‚Ä¢ –ù–ï–õ–¨–ó–Ø –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;
          
          try {
            await supabase.rpc('reset_user_progress', { _user_id: userId });
            
            const { error } = await supabase.auth.admin.deleteUser(userId);
              
            if (error) {
              showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
            } else {
              showModal('–£—Å–ø–µ—Ö', '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã!');
              loadUsers();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
          }
        }
                // ===== –†–ê–ë–û–¢–ê –° –ó–ê–î–ê–ù–ò–Ø–ú–ò =====
        async function loadTasks() {
          const { data, error } = await supabase
            .from('tasks')
            .select('*')
            .order('month_index', { ascending: true });
          
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
            showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ' + error.message);
            return;
          }
          
          const tbody = document.querySelector('#tasksTable tbody');
          tbody.innerHTML = '';
          
          if (!data || data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="text-align:center;padding:20px;">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>`;
            tbody.appendChild(tr);
            return;
          }
          
          const months = ["–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å", "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç"];
          
          data.forEach(task => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${task.title}</td>
              <td>${months[task.month_index - 1] || task.month_index}</td>
              <td>üìù –¢–µ—Å—Ç</td>
              <td>${task.time_limit || 60} –º–∏–Ω</td>
              <td>${task.passing_score}%</td>
              <td>
                <button class="btn btn-small" onclick="editTask('${task.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-small btn-danger" onclick="deleteTask('${task.id}', '${task.title}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        window.showTaskForm = function() {
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
          document.getElementById('taskTitle').value = '';
          document.getElementById('taskMonth').value = '1';
          document.getElementById('taskTimeLimit').value = '60';
          document.getElementById('taskPassingScore').value = '80';
          editingTaskId = null;
          
          renderTaskContent();
        }
        
        window.hideTaskForm = function() {
          document.getElementById('taskFormCard').style.display = 'none';
        }
        
        function renderTaskContent() {
          const contentDiv = document.getElementById('taskContent');
          
          // –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è (mcq)
          contentDiv.innerHTML = `
            <h3>–í–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞</h3>
            <div id="mcqQuestions">
              <div class="subtask-item">
                <div class="form-group">
                  <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                  <input type="text" class="input mcq-question" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                </div>
                <div class="form-group">
                  <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                  <div class="upload-area" id="uploadArea1" onclick="document.getElementById('imageInput1').click()">
                    <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="imageInput1" style="display:none" accept="image/*" onchange="handleImageUpload(this, 1)">
                  </div>
                  <div class="upload-progress" id="progress1">
                    <div class="upload-progress-bar" id="progressBar1"></div>
                  </div>
                  <input type="hidden" class="input mcq-image" id="imageUrl1">
                  <img class="image-preview" id="imagePreview1" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                  <button type="button" class="btn btn-small btn-danger" onclick="removeImage(1)" style="display:none; margin-top:5px;" id="removeBtn1">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
                <div class="form-group">
                  <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                  <textarea class="input mcq-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3" rows="3"></textarea>
                </div>
                <div class="form-group">
                  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                  <input type="number" class="input mcq-correct" min="1" value="1">
                </div>
                <button class="btn btn-small btn-danger" onclick="removeMcqQuestion(this)">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              </div>
            </div>
            <button class="btn btn-small" onclick="addMcqQuestion()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          `;
          
          setupUploadArea(1);
        }
        
        function setupUploadArea(questionIndex) {
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          const imageInput = document.getElementById(`imageInput${questionIndex}`);
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop
          uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });
          
          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
          });
          
          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              imageInput.files = files;
              handleImageUpload(imageInput, questionIndex);
            }
          });
        }
        
        window.handleImageUpload = async function(input, questionIndex) {
          const file = input.files[0];
          if (!file) return;
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
          if (!file.type.match('image.*')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!');
            return;
          }
          
          const progress = document.getElementById(`progress${questionIndex}`);
          const progressBar = document.getElementById(`progressBar${questionIndex}`);
          const preview = document.getElementById(`imagePreview${questionIndex}`);
          const removeBtn = document.getElementById(`removeBtn${questionIndex}`);
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          
          try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imageUrl = await uploadQuestionImage(file, questionIndex);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ
            document.getElementById(`imageUrl${questionIndex}`).value = imageUrl;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            preview.src = imageUrl;
            preview.style.display = 'block';
            removeBtn.style.display = 'block';
            uploadArea.style.display = 'none';
            progressBar.style.width = '100%';
            
            setTimeout(() => {
              progress.style.display = 'none';
            }, 1000);
            
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
            progress.style.display = 'none';
          }
        }
        
        window.removeImage = function(questionIndex) {
          const preview = document.getElementById(`imagePreview${questionIndex}`);
          const removeBtn = document.getElementById(`removeBtn${questionIndex}`);
          const uploadArea = document.getElementById(`uploadArea${questionIndex}`);
          const imageUrlInput = document.getElementById(`imageUrl${questionIndex}`);
          const imageInput = document.getElementById(`imageInput${questionIndex}`);
          
          preview.style.display = 'none';
          removeBtn.style.display = 'none';
          uploadArea.style.display = 'block';
          imageUrlInput.value = '';
          imageInput.value = '';
        }
        
        window.addMcqQuestion = function() {
          const questionsDiv = document.getElementById('mcqQuestions');
          const questionCount = questionsDiv.children.length + 1;
          
          const newQuestion = document.createElement('div');
          newQuestion.className = 'subtask-item';
          newQuestion.innerHTML = `
            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
              <input type="text" class="input mcq-question" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
            </div>
            <div class="form-group">
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
              <div class="upload-area" id="uploadArea${questionCount}" onclick="document.getElementById('imageInput${questionCount}').click()">
                <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                <input type="file" id="imageInput${questionCount}" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${questionCount})">
              </div>
              <div class="upload-progress" id="progress${questionCount}">
                <div class="upload-progress-bar" id="progressBar${questionCount}"></div>
              </div>
              <input type="hidden" class="input mcq-image" id="imageUrl${questionCount}">
              <img class="image-preview" id="imagePreview${questionCount}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
              <button type="button" class="btn btn-small btn-danger" onclick="removeImage(${questionCount})" style="display:none; margin-top:5px;" id="removeBtn${questionCount}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
            <div class="form-group">
              <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
              <textarea class="input mcq-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
              <input type="number" class="input mcq-correct" min="1" value="1">
            </div>
            <button class="btn btn-small btn-danger" onclick="removeMcqQuestion(this)">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          `;
          questionsDiv.appendChild(newQuestion);
          
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ drag and drop –¥–ª—è –Ω–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
          setupUploadArea(questionCount);
        }
        
        window.removeMcqQuestion = function(button) {
          if (document.querySelectorAll('.subtask-item').length > 1) {
            button.closest('.subtask-item').remove();
          } else {
            alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
          }
        }
        
        window.editTask = async function(taskId) {
          const { data: task, error } = await supabase
            .from('tasks')
            .select('*')
            .eq('id', taskId)
            .single();
            
          if (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
            return;
          }
          
          document.getElementById('taskFormCard').style.display = 'block';
          document.getElementById('formTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
          document.getElementById('taskTitle').value = task.title;
          document.getElementById('taskMonth').value = task.month_index;
          document.getElementById('taskTimeLimit').value = task.time_limit || 60;
          document.getElementById('taskPassingScore').value = task.passing_score;
          editingTaskId = taskId;
          
          renderTaskContent();
          
          // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          setTimeout(() => {
            const questions = task.content.questions || [];
            const questionsDiv = document.getElementById('mcqQuestions');
            questionsDiv.innerHTML = '';
            
            questions.forEach((q, i) => {
              const questionIndex = i + 1;
              const questionDiv = document.createElement('div');
              questionDiv.className = 'subtask-item';
              questionDiv.innerHTML = `
                <div class="form-group">
                  <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                  <input type="text" class="input mcq-question" value="${q.q || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å">
                </div>
                <div class="form-group">
                  <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                  <div class="upload-area" id="uploadArea${questionIndex}" onclick="document.getElementById('imageInput${questionIndex}').click()" style="${q.image ? 'display:none' : ''}">
                    <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p class="small-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="imageInput${questionIndex}" style="display:none" accept="image/*" onchange="handleImageUpload(this, ${questionIndex})">
                  </div>
                  <div class="upload-progress" id="progress${questionIndex}">
                    <div class="upload-progress-bar" id="progressBar${questionIndex}"></div>
                  </div>
                  <input type="hidden" class="input mcq-image" id="imageUrl${questionIndex}" value="${q.image || ''}">
                  <img class="image-preview" id="imagePreview${questionIndex}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="display:${q.image ? 'block' : 'none'}" src="${q.image || ''}">
                  <button type="button" class="btn btn-small btn-danger" onclick="removeImage(${questionIndex})" style="display:${q.image ? 'block' : 'none'}; margin-top:5px;" id="removeBtn${questionIndex}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
                <div class="form-group">
                  <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                  <textarea class="input mcq-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1\n–í–∞—Ä–∏–∞–Ω—Ç 2\n–í–∞—Ä–∏–∞–Ω—Ç 3" rows="3">${(q.options || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                  <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1):</label>
                  <input type="number" class="input mcq-correct" min="1" value="${(q.correct || 0) + 1}">
                </div>
                <button class="btn btn-small btn-danger" onclick="removeMcqQuestion(this)">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              `;
              questionsDiv.appendChild(questionDiv);
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ drag and drop
              setupUploadArea(questionIndex);
            });
          }, 100);
        }
        
        window.saveTask = async function() {
          const title = document.getElementById('taskTitle').value;
          const monthIndex = parseInt(document.getElementById('taskMonth').value);
          const timeLimit = parseInt(document.getElementById('taskTimeLimit').value);
          const passingScore = parseInt(document.getElementById('taskPassingScore').value);
          
          if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è');
            return;
          }
          
          const questions = [];
          const questionElements = document.querySelectorAll('.subtask-item');
          
          if (questionElements.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            return;
          }
          
          for (let i = 0; i < questionElements.length; i++) {
            const item = questionElements[i];
            const question = item.querySelector('.mcq-question').value;
            const imageUrl = document.getElementById(`imageUrl${i + 1}`).value;
            const optionsText = item.querySelector('.mcq-options').value;
            const correct = parseInt(item.querySelector('.mcq-correct').value) - 1;
            
            if (!question) {
              alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞');
              return;
            }
            
            const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
            
            if (correct < 0 || correct >= options.length) {
              alert('–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–¥–Ω–æ–º—É –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
              return;
            }
            
            questions.push({
              q: question,
              image: imageUrl || null,
              options: options,
              correct: correct
            });
          }
          
          const content = { questions };
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ
          try {
            if (editingTaskId) {
              // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
              const { error } = await supabase
                .from('tasks')
                .update({ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: 'mcq', 
                  passing_score: passingScore, 
                  content 
                })
                .eq('id', editingTaskId);
                
              if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
              } else {
                alert('–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                hideTaskForm();
                loadTasks();
              }
            } else {
              // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
              const { error } = await supabase
                .from('tasks')
                .insert([{ 
                  title, 
                  month_index: monthIndex, 
                  time_limit: timeLimit, 
                  type: 'mcq', 
                  passing_score: passingScore, 
                  content 
                }]);
                
              if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
              } else {
                alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
                hideTaskForm();
                loadTasks();
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
          }
        }
        
        window.deleteTask = async function(taskId, taskTitle) {
          if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ "${taskTitle}"?\n\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;
          
          try {
            const { error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
              
            if (error) {
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
            } else {
              alert('–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
              loadTasks();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
          }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        await initAdmin();
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: ' + error.message);
        return false;
      }
    }
    
    const configTimeout = setTimeout(() => {
      if (!window.SUPABASE_URL) {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è...');
        window.SUPABASE_URL = 'https://dtjhlanmwjpdcdxgzzyo.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0amhsYW5td2pwZGNkeGd6enlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDUwOTIsImV4cCI6MjA3MjM4MTA5Mn0.jS4DXQSOBawRFtnzjsmF5AzzltDYAG0AXrwrY1B0UpY';
        initApp();
      }
    }, 5000);
    
    window.addEventListener('configLoaded', () => {
      clearTimeout(configTimeout);
      initApp();
    });
    
    if (window.SUPABASE_URL) {
      clearTimeout(configTimeout);
      initApp();
    }
  </script>
</body>
</html>