<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="mark">EK</div>
        <div>
          <h3>Edu Keys</h3>
          <div class="small-muted">–£—á–µ–±–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn" onclick="location.href='/tasks.html'">–ö –∑–∞–¥–∞–Ω–∏—è–º</button>
        <button class="btn secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="grid-2">
      <!-- left: profile -->
      <div class="card profile-card">
        <div class="profile-avatar" role="img" aria-label="–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞">
          <svg viewBox="0 0 200 200" preserveAspectRatio="none" style="width:100%;height:100%;border-radius:12px">
            <rect width="100%" height="100%" fill="#fff8e6"/>
            <circle cx="100" cy="80" r="28" fill="#ffd166"/>
            <g transform="translate(22,120)">
              <ellipse cx="30" cy="10" rx="30" ry="12" fill="#cde6ff"/>
              <ellipse cx="70" cy="10" rx="30" ry="12" fill="#cde6ff"/>
            </g>
          </svg>

          <!-- overlayed key circles -->
          <div class="key-circles" id="keyCircles">
            <div class="key-circle kpos1" data-index="1"></div>
            <div class="key-circle kpos2" data-index="2"></div>
            <div class="key-circle kpos3" data-index="3"></div>
            <div class="key-circle kpos4" data-index="4"></div>
            <div class="key-circle kpos5" data-index="5"></div>
            <div class="key-circle kpos6" data-index="6"></div>
            <div class="key-circle kpos7" data-index="7"></div>
          </div>
        </div>

        <div class="profile-info">
          <h3 id="fullname">–£—á–µ–Ω–∏–∫</h3>
          <div class="small-muted" id="emailText">‚Äî</div>
          <div style="margin-top:12px">
            <span class="badge" id="keysCount">–ö–ª—é—á–µ–π: 0/7</span>
            <span class="badge" style="background:var(--accent)" id="attemptsCount">–ü–æ–ø—ã—Ç–æ–∫: 0</span>
          </div>
        </div>
      </div>

      <!-- right: progress / months -->
      <div>
        <div class="card">
          <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
          <div id="monthsList" style="margin-top:12px"></div>
        </div>

        <div style="height:18px"></div>

        <div class="card">
          <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <p class="small-muted">–ö—Ä—É–∂–∫–∏ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –∑–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü. –ù–∞–∂–º–∏ ¬´–ö –∑–∞–¥–∞–Ω–∏—è–º¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
          <p class="small-muted">–ó–∞–¥–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –º–µ—Å—è—Ü–µ —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞ (—Å —Å–µ–Ω—Ç—è–±—Ä—è –ø–æ –º–∞—Ä—Ç).</p>
          <p class="small-muted"><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ö–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–¥–∞–Ω–∏—è. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã!</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/config.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY)

    const months = ["–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å","–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç"]

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —É—á–µ–±–Ω—ã–π –º–µ—Å—è—Ü (1-7)
    function getStudyIndex() {
      const now = new Date();
      const month = now.getMonth() + 1; // 1-12
      
      // –£—á–µ–±–Ω—ã–π –≥–æ–¥ —Å —Å–µ–Ω—Ç—è–±—Ä—è –ø–æ –∞–≤–≥—É—Å—Ç
      if (month >= 9) {
        return month - 8; // –°–µ–Ω—Ç—è–±—Ä—å=1, –û–∫—Ç—è–±—Ä—å=2, ..., –î–µ–∫–∞–±—Ä—å=4
      } else {
        return month + 4; // –Ø–Ω–≤–∞—Ä—å=5, ..., –ê–≤–≥—É—Å—Ç=12 (–Ω–æ —É –Ω–∞—Å —Ç–æ–ª—å–∫–æ –¥–æ –º–∞—Ä—Ç–∞=7)
      }
    }

    async function loadProfile(){
      const { data: { user } } = await supabase.auth.getUser()
      if(!user) { 
        location.href = '/login.html'; 
        return; 
      }

      // profile table
      const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single()
      document.getElementById('fullname').textContent = profile?.full_name || '–£—á–µ–Ω–∏–∫'
      document.getElementById('emailText').textContent = user.email
      document.getElementById('attemptsCount').textContent = `–ü–æ–ø—ã—Ç–æ–∫: ${profile?.attempts || 0}`

      // keys
      const { data: keys } = await supabase.from('keys').select('*').eq('user_id', user.id)
      const got = keys?.length || 0
      document.getElementById('keysCount').textContent = `–ö–ª—é—á–µ–π: ${got}/7`

      // fill circles
      document.querySelectorAll('.key-circle').forEach(el => {
        const idx = parseInt(el.dataset.index, 10)
        const found = keys?.some(k => k.month_index === idx)
        if (found) { 
          el.classList.add('filled') 
        } else { 
          el.classList.remove('filled') 
        }
      })

      // months list + status
      const monthsContainer = document.getElementById('monthsList')
      monthsContainer.innerHTML = ''
      
      const currentMonthIndex = getStudyIndex()
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ø—ã—Ç–∫–∞—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
      const { data: attempts } = await supabase.from('attempts').select('*, tasks!inner(month_index)').eq('user_id', user.id)
      const { data: tasks } = await supabase.from('tasks').select('*')
      
      for (let i = 1; i <= 7; i++) {
        const hasKey = keys?.some(k => k.month_index === i) || false
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –¥–ª—è –º–µ—Å—è—Ü–∞
        const hasAttemptForMonth = attempts?.some(a => a.tasks.month_index === i) || false
        const isAvailable = i <= currentMonthIndex
        const isCompleted = hasKey
        
        let status = ''
        if (isCompleted) {
          status = '‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'
        } else if (hasAttemptForMonth) {
          status = '‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞'
        } else if (isAvailable) {
          status = 'üü° –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
        } else {
          status = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'
        }
        
        const li = document.createElement('div')
        li.className = 'month-row'
        li.innerHTML = `
          <div class="month-title">
            <div><b>${months[i-1]}</b></div>
            <div><span class="small-muted">${status}</span></div>
          </div>
        `
        monthsContainer.appendChild(li)
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut()
      location.href = '/login.html'
    })

    document.addEventListener('DOMContentLoaded', loadProfile)
  </script>
</body>
</html>