<!doctype html>
<html>
<head>
  <meta charset="utf-8">
    <title>–°–æ–∑–¥–∞—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</title>
      <link rel="stylesheet" href="css/style.css">
      </head>
      <body class="centered">
      <div class="card">
        <h2 id="formTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
        
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="title" style="width:100%;padding:8px;margin:5px 0;">
            
              <label>–ú–µ—Å—è—Ü:</label>
                <select id="month" style="width:100%;padding:8px;margin:5px 0;">
                    <option value="1">–°–µ–Ω—Ç—è–±—Ä—å</option>
                        <option value="2">–û–∫—Ç—è–±—Ä—å</option>
                            <option value="3">–ù–æ—è–±—Ä—å</option>
                                <option value="4">–î–µ–∫–∞–±—Ä—å</option>
                                    <option value="5">–Ø–Ω–≤–∞—Ä—å</option>
                                        <option value="6">–§–µ–≤—Ä–∞–ª—å</option>
                                            <option value="7">–ú–∞—Ä—Ç</option>
                                              </select>
                                              
                                                <label>–¢–∏–ø:</label>
                                                  <select id="type" style="width:100%;padding:8px;margin:5px 0;">
                                                      <option value="mcq">–¢–µ—Å—Ç (MCQ)</option>
                                                          <option value="fill">–ü—Ä–æ–ø—É—Å–∫–∏ (fill-in)</option>
                                                            </select>
                                                            
                                                              <div id="questionsContainer"></div>
                                                                <button class="btn" id="addQuestionBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                                                                  <br>
                                                                    <button class="btn" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                                      <button class="btn secondary" onclick="window.location.href='/admin.html'">–ù–∞–∑–∞–¥</button>
                                                                      </div>
                                                                      
                                                                      <script src="/config.js"></script>
                                                                      <script type="module">
                                                                        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
                                                                          const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY)
                                                                          
                                                                            const params = new URLSearchParams(window.location.search)
                                                                              const taskId = params.get('id')
                                                                                const container = document.getElementById('questionsContainer')
                                                                                  const typeSelect = document.getElementById('type')
                                                                                    let questions=[]
                                                                                    
                                                                                      function renderQuestions(){
                                                                                          container.innerHTML=''
                                                                                              questions.forEach((q,i)=>{
                                                                                                    const div=document.createElement('div')
                                                                                                          div.innerHTML=`<p><b>–í–æ–ø—Ä–æ—Å ${i+1}:</b></p>
                                                                                                                  <input type="text" placeholder="–í–æ–ø—Ä–æ—Å" value="${q.q||''}" class="qInput" style="width:100%;padding:5px;margin:3px 0;">
                                                                                                                          ${typeSelect.value==='mcq'?`
                                                                                                                                    <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ ;" value="${q.options? q.options.join(';') : ''}" style="width:100%;padding:5px;margin:3px 0;">
                                                                                                                                              <input type="number" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (0,1,2...)" value="${q.correct||0}" style="width:100%;padding:5px;margin:3px 0;">` : ''}
                                                                                                                                                      <button class="btn small secondary" onclick="removeQuestion(${i})">–£–¥–∞–ª–∏—Ç—å</button>
                                                                                                                                                              <hr>`
                                                                                                                                                                    container.appendChild(div)
                                                                                                                                                                        })
                                                                                                                                                                          }
                                                                                                                                                                          
                                                                                                                                                                            function removeQuestion(i){ questions.splice(i,1); renderQuestions() }
                                                                                                                                                                              document.getElementById('addQuestionBtn').addEventListener('click',()=>{ questions.push({}); renderQuestions() })
                                                                                                                                                                                typeSelect.addEventListener('change',()=>{ renderQuestions() })
                                                                                                                                                                                
                                                                                                                                                                                  async function loadTask(){
                                                                                                                                                                                      if(!taskId) return
                                                                                                                                                                                          const { data,error } = await supabase.from('tasks').select('*').eq('id',taskId).single()
                                                                                                                                                                                              if(error) return
                                                                                                                                                                                                  document.getElementById('formTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ'
                                                                                                                                                                                                      document.getElementById('title').value=data.title
                                                                                                                                                                                                          document.getElementById('month').value=data.month_index
                                                                                                                                                                                                              document.getElementById('type').value=data.type
                                                                                                                                                                                                                  questions=data.content.questions||[]
                                                                                                                                                                                                                      renderQuestions()
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        
                                                                                                                                                                                                                          async function saveTask(){
                                                                                                                                                                                                                              const title=document.getElementById('title').value
                                                                                                                                                                                                                                  const month=document.getElementById('month').value
                                                                                                                                                                                                                                      const type=document.getElementById('type').value
                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                          const content=type==='mcq'?questions.map((q,i)=>({
                                                                                                                                                                                                                                                q: container.querySelectorAll('.qInput')[i].value,
                                                                                                                                                                                                                                                      options: container.querySelectorAll('input[type="text"]')[i+1].value.split(';'),
                                                                                                                                                                                                                                                            correct: parseInt(container.querySelectorAll('input[type="number"]')[i].value)
                                                                                                                                                                                                                                                                })): { text: container.querySelector('.qInput').value }
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                    if(taskId){
                                                                                                                                                                                                                                                                          await supabase.from('tasks').update({title,month_index:month,type,content}).eq('id',taskId)
                                                                                                                                                                                                                                                                              } else {
                                                                                                                                                                                                                                                                                    await supabase.from('tasks').insert({title,month_index:month,type,content})
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                            window.location.href='/admin.html'
                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                document.getElementById('saveBtn').addEventListener('click', saveTask)
                                                                                                                                                                                                                                                                                                  loadTask()
                                                                                                                                                                                                                                                                                                  </script>
                                                                                                                                                                                                                                                                                                  </body>
                                                                                                                                                                                                                                                                                                  </html>
                                                                                                                                                                                                                                                                                                  >