<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ó–∞–¥–∞–Ω–∏—è ‚Äî Edu Keys</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .attempt-info {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .warning-note {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
    }
    .start-warning {
      background: #ffeaa7;
      border: 2px solid #fdcb6e;
      border-radius: 8px;
      padding: 10px;
      margin-top: 5px;
      font-size: 13px;
    }
    .month-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .loading { 
      text-align: center; 
      padding: 40px; 
      display: none;
    }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid var(--accent2); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 20px; 
      border-radius: 8px; 
      margin: 20px; 
      text-align: center; 
      display: none; 
    }
  </style>
  
  <script src="/load-config.js"></script>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...</p>
  </div>
  
  <div id="errorMessage" class="error"></div>
  
  <div id="mainContent" style="display: none;">
    <div class="container">
      <div class="header">
        <div class="logo"><div class="mark">EK</div><div><h3>–ó–∞–¥–∞–Ω–∏—è</h3><div class="small-muted">–í—ã–±–∏—Ä–∞–π –∏ –ø—Ä–æ—Ö–æ–¥–∏</div></div></div>
        <div class="nav">
          <button class="btn" onclick="location.href='/profile.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="attempt-info">
        <strong>üí° –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –∑–∞–¥–∞–Ω–∏—é. 
        –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã! –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram: @skebobingg
      </div>

      <div class="card">
        <div id="monthsRoot"></div>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById('loading').style.display = 'block';
    
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    function showContent() {
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    async function initApp() {
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
        return false;
      }
      
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        const months = ["–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å","–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç"];

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —É—á–µ–±–Ω—ã–π –º–µ—Å—è—Ü (1-7)
        function getStudyIndex() {
          const now = new Date();
          const month = now.getMonth() + 1;
          
          if (month >= 9) {
            return month - 8;
          } else {
            return month + 4;
          }
        }

        async function loadTasks() {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) { 
            location.href = '/login.html'; 
            return; 
          }

          const { data: tasks } = await supabase.from('tasks').select('*').order('month_index');
          const { data: attempts } = await supabase.from('attempts').select('*').eq('user_id', user.id);
          const { data: keys } = await supabase.from('keys').select('*').eq('user_id', user.id);

          const root = document.getElementById('monthsRoot');
          root.innerHTML = '';

          const currentMonthIndex = getStudyIndex();

          for (let mi = 1; mi <= 7; mi++) {
            const monthTasks = (tasks || []).filter(t => t.month_index === mi);
            if (monthTasks.length === 0) continue;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–µ—Å—è—Ü–∞
            const hasKeyForMonth = (keys || []).some(k => k.month_index === mi);
            const hasAnyAttemptForMonth = (attempts || []).some(a => {
              const task = monthTasks.find(t => t.id === a.task_id);
              return task !== undefined;
            });
            
            let monthStatus = '';
            let monthStatusIcon = '';
            
            if (hasKeyForMonth) {
              monthStatus = 'üóùÔ∏è –ü–æ–ª—É—á–µ–Ω –∫–ª—é—á';
              monthStatusIcon = 'üóùÔ∏è';
            } else if (hasAnyAttemptForMonth) {
              monthStatus = '‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞';
              monthStatusIcon = '‚ùå';
            } else if (mi <= currentMonthIndex) {
              monthStatus = '‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ';
              monthStatusIcon = '‚úÖ';
            } else {
              monthStatus = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
              monthStatusIcon = 'üîí';
            }

            const box = document.createElement('div');
            box.className = 'month-row';
            const title = document.createElement('div');
            title.className = 'month-title';
            
            title.innerHTML = `
              <div><b>${months[mi-1]}</b></div>
              <div class="month-status">
                <span class="small-muted">${monthStatus}</span>
              </div>
            `;
            box.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tasks-grid';
            
            monthTasks.forEach(t => {
              const card = document.createElement('div');
              card.className = 'task-card';
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ
              const attempt = (attempts || []).find(a => a.task_id === t.id);
              const hasKeyForMonth = (keys || []).some(k => k.month_index === t.month_index);
              
              card.innerHTML = `
                <h4>${t.title}</h4>
                <p>–¢–∏–ø: üìù –¢–µ—Å—Ç ‚Ä¢ –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${t.passing_score}% ‚Ä¢ –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏: ${t.time_limit || 60} –º–∏–Ω</p>
              `;
              
              const meta = document.createElement('div');
              meta.className = 'meta';
              
              const btn = document.createElement('button');
              btn.className = 'btn small';
              
              if (hasKeyForMonth) {
                // –ï—Å–ª–∏ –∫–ª—é—á –∑–∞ –º–µ—Å—è—Ü —É–∂–µ –ø–æ–ª—É—á–µ–Ω
                btn.textContent = 'üóùÔ∏è –ö–ª—é—á –ø–æ–ª—É—á–µ–Ω';
                btn.disabled = true;
                btn.classList.add('ghost');
              } else if (attempt) {
                // –ï—Å–ª–∏ –±—ã–ª–∞ –ø–æ–ø—ã—Ç–∫–∞ (–ª—é–±–∞—è) - –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç
                btn.textContent = '‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞';
                btn.disabled = true;
                btn.classList.add('ghost');
                card.innerHTML += `<div class="warning-note">–î–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω—É –≤ Telegram: @skebobingg</div>`;
              } else if (mi <= currentMonthIndex) {
                // –ï—Å–ª–∏ –º–µ—Å—è—Ü –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–µ –±—ã–ª–æ –ø–æ–ø—ã—Ç–æ–∫
                btn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
                btn.onclick = () => {
                  if (confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –∑–∞–¥–∞–Ω–∏—é –ø–æ–ø—ã—Ç–∫–∞ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?')) {
                    location.href = `/task.html?id=${t.id}`;
                  }
                };
                card.innerHTML += `<div class="start-warning">‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—à–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ</div>`;
              } else {
                // –ï—Å–ª–∏ –º–µ—Å—è—Ü –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
                btn.textContent = 'üîí –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                btn.disabled = true;
                btn.classList.add('ghost');
              }
              
              meta.appendChild(btn);
              card.appendChild(meta);
              grid.appendChild(card);
            });
            
            box.appendChild(grid);
            root.appendChild(box);
          }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            await supabase.auth.signOut();
            location.href = '/login.html';
          }
        });

        await loadTasks();
        showContent();
        return true;
        
      } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ' + error.message);
        return false;
      }
    }
    
    const configTimeout = setTimeout(() => {
      if (!window.SUPABASE_URL) {
        showError('‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è...');
        window.SUPABASE_URL = 'https://dtjhlanmwjpdcdxgzzyo.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0amhsYW5td2pwZGNkeGd6enlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDUwOTIsImV4cCI6MjA3MjM4MTA5Mn0.jS4DXQSOBawRFtnzjsmF5AzzltDYAG0AXrwrY1B0UpY';
        initApp();
      }
    }, 5000);
    
    window.addEventListener('configLoaded', () => {
      clearTimeout(configTimeout);
      initApp();
    });
    
    if (window.SUPABASE_URL) {
      clearTimeout(configTimeout);
      initApp();
    }
  </script>
</body>
</html>